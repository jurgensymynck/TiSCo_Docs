<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TiSCo project: Calibration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">TiSCo project<span id="projectnumber">&#160;0.90-alpha</span>
   </div>
   <div id="projectbrief">A framework of robot control software and IT hardware.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search',true);
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_d_o_x_y__c_a_l_i_b_r_a_t_i_o_n.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Calibration</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document describes the full calibration procedure for one <em>joint</em>: a modified servo, paired with a low cost potentiometer or joystick.</p>
<p>Calibration preparation:</p>
<ol type="1">
<li>Verify that all servos have an unique identifier, preferably labeled with a large self-adhesive label (e.g. 'U1' or 'S10'). Already labeled servos might have been calibrated previously. Check the codebase for earlier calibration values if desired.</li>
<li>Verify that all servo are correctly connected to their extension cables: same color wires should be connected with each other, and not the wrong way around. Note especially black to black connections.</li>
<li>Connect the servo to a free pin header on the PWM servo shield, check the correct orientation.</li>
<li>Check that all connections are well made: remove and reattach connections, or wiggle around connections to ensure good electrical conductivity.</li>
<li>Decide on the PWM frequency to be used. Hobby servos generally run on 50 Hz but overclocked frequencies like 60 Hz are possible.</li>
</ol>
<p>The full robot calibration procedure must follow these steps:</p>
<ol type="1">
<li>Decide on the <a class="el" href="#PWM_FREQUENCY">PWM frequency</a> to be used and document this along with the calibration values.</li>
<li>Determination of <a class="el" href="#DOXY_CALIB_SERVO_LIMITS">Servo Lower and Upper Software Limits (JOINTPWMPULSE)</a>.</li>
<li>Determination of <a class="el" href="#DOXY_CALIB_JOINTPWMPULSE_LIMITS">Joint Lower and Upper Software Limits (JOINTPWMPULSE)</a>.</li>
<li><a class="el" href="#DOXY_ENTERING_LIMITS_IN_FIRMWARE_AND_COSMOS">Entering servo and joint limits </a> in <code>g_joint_preset[NUMBER_OF_JOINTS]</code> in file <code>calibration_and_settings.h</code> and entering them as limits in the telemetry definition of <code>JOINTPWMPULSE</code> in file <code>tlm.txt</code>.</li>
<li>Determination of <a class="el" href="#DOXY_CALIB_JOINTANGLE_RAW_LIMITS">Joint/Servo Internal Angle Feedback Potentiometer Limits (JOINTANGLE_RAW)</a> and also entering them in <code>g_joint_preset[NUMBER_OF_JOINTS]</code>.</li>
<li>Determination of <a class="el" href="#DOXY_CALIB_JOINTINPUT_LIMITS">Joint Analog Input Potentiometer Limits (JOINTINPUT_RAW)</a>.</li>
</ol>
<h1><a class="anchor" id="PWM_FREQUENCY"></a>
PWM frequency</h1>
<p>Standard hobby servos typically operate at a PWM (Pulse Width Modulation) frequency of 50 Hz. However, they can be overclocked to frequencies of 60 Hz or higher. The upper frequency limit is determined by the stability of the servo's internal control loop. If the frequency is too high, the servos may start to move erratically, signaling that the maximum allowable PWM frequency has been exceeded.</p>
<p>The PWM frequency generated by the PWM boards like <a href="https://www.adafruit.com/product/815">this PCA9685 based PWM Driver board</a> is not very precise and can vary significantly between boards. For example, after successful calibration on PWM board A, swapping it for another board B (due to malfunction, for instance) may cause substantial deviations in the rest positions and other positions of the robot.</p>
<p>More critically, the servos connected to board B might attempt to move beyond the joint safety limits set by board A. In the best-case scenario, the joint and servo software limits will activate, triggering an error message on the debug serial output. However, if this occurs during calibration—when safe joint limits are temporarily disabled—permanent damage to the servos may result.</p>
<p>Therefore, it is recommended to monitor the actual PWM frequency using an oscilloscope and aim to set an exact frequency during PWM initialization in the TiSCo firmware.</p>
<center> <img src="PCA9685_Frequency_60Hz_SCALED.jpg" alt="Setting a PWM frequency of 62 Hz results in 60.0896 Hz" height="240" class="inline"/> </center><p>This process is not straightforward because it is impossible to specify an exact frequency (e.g., 60.0000 Hz) due to the <a href="https://github.com/NachtRaveVL/PCA9685-Arduino">PCA9685 library</a> using integer division. Instead, one must find a PWM frequency that best approximates the desired frequency. With the hardware currently at our disposal, setting a 62 Hz frequency results in 60.0896 Hz (see image).</p>
<p>It might be possible to remap the joint safety limits from board A to board B using linear interpolation, but this has yet to be determined.</p>
<h1><a class="anchor" id="DOXY_CALIB_SERVO_LIMITS"></a>
Servo Lower and Upper Software Limits (JOINTPWMPULSE)</h1>
<h2><a class="anchor" id="DOXY_CALIB_SERVO_LIMITS_INTRO"></a>
Introduction</h2>
<p>To protect a servos fragile inner end-of-sweep hardware limits, software limits must be determined and set. Joint::pwm_pulse_set() will only send pulse values that are <em>equal or more conservative</em> than the software lower/upper limits (a notable exception is the special PCA9685_PWM_FULL pulse setting).</p>
<p>Hobby servos are almost all rated for 180° shaft angle sweep, but mechanically they can rotate a few degrees more. Pushing the servo sweep limits is a bad idea however, because the servo might hit its internal hardware limits. For the powerful Hitec HS-625MG and HS-645MG, these hardware limits are simple plastic protrusions that are easily sheared off when the servo tries to move past them (PICTURE NEEDED). See figure, the red contoured servo arms represent the most extreme rotation angles, from lower to upper servo internal hardware limit.</p>
<center> <img src="Hitec_unsafe_sweep1.png" alt="Hitec servo shaft most extreme sweep angles, against hardware limits" height="130" class="inline"/> </center><p>The servo <em>software</em> limits should prevent accidentally hitting these hardware limits. After calibrating, the maximum servo sweep should be limited to 180°. See figure, green contoured servo arms represent the safe 180° sweep angle, avoiding hitting the hardware limits.</p>
<center> <img src="Hitec_safe_sweep1.png" alt="Hitec servo shaft, safe 180° sweep angle, avoiding hardware limits." height="130" class="inline"/> </center><h2><a class="anchor" id="DOXY_CHECK_SERVO_ARM_MOUNTING"></a>
Check Correct Servo Arm Mounting on Shaft</h2>
<p>For this part of the procedure the servos do not need to be connected to the PWM shield.</p>
<ol type="1">
<li><p class="startli">Unscrew the screw that connects the servo arm to the servo shaft</p>
<p class="startli"><img src="Hitec_Arm_Screw2.jpg" alt="Hitec servo with arm and screw in place" height="100" class="inline"/></p>
</li>
<li>Remove the servo arm.</li>
<li><p class="startli">The servo shaft with its 25 splines (see Hitec datasheet) is visible. Note the line marking on the shaft.</p>
<p class="startli"><img src="Hitec_NoArm_NoScrew_Detail.jpg" alt="Hitec servo without arm or screw." height="100" class="inline"/></p>
</li>
<li><p class="startli">Replace the servo arm on the shaft so that it is aligned with the shaft line marking. There is no need to mount the screw yet. If the line marking was not pointing 'upwards' already, GENTLY rotate the shaft so that the arm and the now hidden line shaft marking are pointing 'upwards' (see picture). The arm now marks the halfway point of the servos total angle sweep range.</p>
<p class="startli"><img src="Hitec_Arm_NoScrew3.jpg" alt="Hitec servo without arm or screw." height="100" class="inline"/></p>
</li>
<li><p class="startli">Gently rotate the arm counterclockwise (CCW) until the hardware limit is reached, then rotate clockwise (CW) towards the other hardware limit (see image, red contoured arms).</p>
<p class="startli"><img src="Hitec_unsafe_sweep1.png" alt="Hitec servo shaft most extreme sweep angles, against hardware limits" height="120" class="inline"/></p>
<dl class="section note"><dt>Note</dt><dd>This movement should run smoothly without crackling noises or noticeable counteraction. If not, the servo is likely (already) damaged internally: broken gear teeth or sheared-off plastic fragments of the hardware limits that block the gear train. Discard the servo or repair with a servo gear revision set. <br  />
 In the rare case that extreme positions are not distributed evenly around the halfway point (the arm is noticeably <em>not</em> facing upwards), remove the arm and reposition it with a <em>one tooth</em> offset in the correcting direction. Repeat steps until good symmetry is achieved.</dd></dl>
</li>
<li>Gently move the servo arm to the halfway position (facing 'up').</li>
</ol>
<h2><a class="anchor" id="DOXY_DETERMINE_SERVO_LIMITS"></a>
Determine Servo Software Limits</h2>
<p>Now that the servo arm is correctly mounted to the shaft and the latter is at the halfway point, we can determine what the pulse values for <em>safer</em> sweep limits are.</p>
<dl class="section warning"><dt>Warning</dt><dd>Determinining the safe limits requires replacing existing safety limits with unsafe values (g_servo_pulse_abs_lower_limit and g_servo_pulse_abs_upper_limit)!<ul>
<li>Don't use any other servo driving command than <code>CMD_SET_JOINT_STEP</code>.</li>
<li>Only power on one servo at the time (<code>CMD_SET_JOINT_POWER_ON</code>).</li>
<li>Be careful not to drive the servo against its internal hardware limits.</li>
</ul>
</dd></dl>
<p>In the code (<code>calibration_and_settings.h</code>), deactivate any earlier software limits by replacing the values with the provided macro constants (see definition). Recompile and upload the temporary unsafe code.</p>
<center> <img src="g_joint_preset[NUMBER_OF_JOINTS]_0.png" alt="" class="inline"/> </center> <p>In the following instructions, a servo labeled 'S1' is connected to the fourth slot on the PWM servo shield (position '3', so 'servo 3' or 'joint 3').</p>
<p>For simplicity, the instructions are presented as bare commands, to be executed using the Command Sender. All commands have much more user friendly graphical interfaces however, in one or more Telemetry Screens.</p>
<ol type="1">
<li>Gently move the servo arm to the halfway position (facing 'up'), if not already done so. If this is not possible then the servo might jerk a little when powered on later.</li>
<li>If the servo power is not connected yet: first connect the USB cable to the Arduino Mega, then connect servo power cable.</li>
<li>Start COSMOS software and start 'Command and Telemetry Server'.<ul>
<li>Under 'Interfaces', check that <code>TISCO_INT</code> is connected.</li>
<li>Check under tab 'Tlm Packets' that with regular intervals, <code>TLM_PING</code> packets are received.</li>
<li>Start the Telemetry Packet Viewer and select packet <code>TLM_JOINTPWMPULSE</code> for viewing.</li>
<li>Start the Command Sender:<ul>
<li>Send command to set telemetry and sample rate to 25/s: <br  />
 <code>CMD_SET_RATE with WHICH_RATE? TLM_AND_SAMPLE, RATE 25</code></li>
<li>Send command to attach the telemetry and sample interrupt routine: <br  />
 <code>CMD_ATTACH_DETACH_TLM_AND_SAMPLE_INTERRUPT with WHICH? ATTACH</code></li>
<li>Send command to periodically fetch the necessary telemetry data: <br  />
 <code>CMD_FETCH_JOINTPWMPULSE with ACQ_MODE PERIODICAL</code></li>
</ul>
</li>
<li>In the Telemetry Packet Viewer, the packets should be incoming.</li>
</ul>
</li>
<li>Still in Command Sender, activate power on servo 3: <br  />
 <code>CMD_SET_JOINT_POWER_ON with PWM_CHANNEL_NUMBER 3</code> <br  />
 One might observe a shudder on the servo. Try to rotate the shaft by hand and one notices that the servo tries to hold its position. <br  />
 In the Telemetry Packet Viewer, under <code>JOINTPWMPULSE_3</code>, a value around <code>310</code> is displayed (this is the pulse value for the halfway point of the servo sweep range).</li>
<li>Rotate the shaft using command <code>CMD_SET_JOINT_STEP</code> for <code>PWM_CHANNEL_NUMBER 3</code> and a <code>STEP_SIZE</code> of choice. <br  />
 Positive values step servos in clockwise (CW) direction, negatives in the counterclockwise (CCW) direction.<ul>
<li><p class="startli">First, rotate the servo axis CCW until the servo arm is perfectly left-horizontally aligned (see picture, green contour).</p>
<p class="startli"><img src="Hitec_safe_sweep1.png" alt="Hitec servo shaft, safe 180° sweep angle, avoiding hardware limits." height="100" class="inline"/></p>
<p class="startli">In the Telemetry Packet Viewer, under <code>JOINTPWMPULSE_3</code>, a low value around <code>100-150</code> is displayed: this is the pulse value for this servos counterclockwise, lower software limit. <b>Remember this value</b>.</p>
</li>
<li>Repeat above steps but now proceed clockwise with positive step values, until the servo arm is perfectly right-horizontally aligned. <br  />
 In the Telemetry Packet Viewer, under <code>JOINTPWMPULSE_3</code>, a high value around <code>490-530</code> is displayed: this is the pulse value for this servos clockwise, upper software limit. <b>Remember this value</b>.</li>
</ul>
</li>
<li>Power off the servo: <br  />
 <code>CMD_SET_JOINT_POWER_OFF with PWM_CHANNEL_NUMBER 3</code></li>
<li>Repeat above steps for each servo.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>These software limits will activate <em>before</em> the servos internal hardware limits are reached, but in practice, a servo will be part of a 'joint' that has its own (external) hardware limits (see <a class="el" href="#DOXY_CALIB_JOINTPWMPULSE_LIMITS">Joint Lower and Upper Software Limits (JOINTPWMPULSE)</a>). <br  />
 Servo lower and upper limits should be determined only once and are not subject to change, because they are an unique, internal property of a specific servo and should not be influenced by the internal servo feedback control circuits or other factors. <br  />
 It's a good idea to make a list of all servo software limits for all servos at ones disposal, for future use.</dd></dl>
<h1><a class="anchor" id="DOXY_CALIB_JOINTPWMPULSE_LIMITS"></a>
Joint Lower and Upper Software Limits (JOINTPWMPULSE)</h1>
<p>This section describes how to determine the <em>joint</em> lower and upper software limits: the limits for a servo that is already mounted in a joint mechanism (see figure).</p>
<dl class="section warning"><dt>Warning</dt><dd>Only attempt setting the <em>joint</em> software limits after the <em>servo</em> software limits are determined and properly set in the firmware as described in <a class="el" href="#DOXY_CALIB_SERVO_LIMITS">Servo Lower and Upper Software Limits (JOINTPWMPULSE)</a>.</dd></dl>
<p>Consider the servo labeled 'U3' in the prototype. The images show the top view, looking at the bottom of the servo. </p><dl class="section note"><dt>Note</dt><dd>When looking at the bottom of the servo as in image tisco-U1_Joint_ext_hardware-stop_1 'clockwise' and 'counterclockwise' are reversed.</dd></dl>
<center> <img src="tisco-U1_Joint_ext_hardware-stop_1.jpg" alt="" height="320" class="inline"/> <img src="tisco-U1_Joint_ext_hardware-stop_2.jpg" alt="" height="320" class="inline"/> <img src="tisco-U1_Joint_ext_hardware-stop_3.jpg" alt="" height="320" class="inline"/> </center><ol type="1">
<li>Verify that the joint is properly designed and that the servo is not allowed to move against its internal hardware limits!</li>
<li>Follow the steps described in <a class="el" href="#DOXY_CALIB_SERVO_LIMITS">Servo Lower and Upper Software Limits (JOINTPWMPULSE)</a>. Pay close attention that the joint is free to move up to its hardware limits (see images, red line markings). If not, see DOXY_TROUBLESHOOTING. <br  />
 Allow the joint to lightly touch its hardware limit, or stay away a few pulses/degrees. Also, the servo should not actively (and audibly) push against the hardware limit. Check the joint current draw, it should not be noticeable higher than the in-between positions. <br  />
 The acquired pulse values are now called <em>joint (counterclockwise) lower software limit</em> and <em>joint (clockwise) upper software limit</em>. <b>Remember these values</b>.</li>
</ol>
<p>These acquired values are the real, practical software limits that should be used for safeguarding the the servos <em>and</em> the joint mechanisms.</p>
<h1><a class="anchor" id="DOXY_ENTERING_LIMITS_IN_FIRMWARE_AND_COSMOS"></a>
Entering Limit Values in Firmware and COSMOS</h1>
<p>Open <code>calibration_and_settings.h</code> and enter all servo and joint limit values in the provided <code>g_joint_preset[NUMBER_OF_JOINTS]</code> array.</p>
<center> <img src="g_joint_preset[NUMBER_OF_JOINTS]_1.png" alt="" class="inline"/> </center><dl class="section note"><dt>Note</dt><dd>On the line with comment <code>[0], 'U1'</code>, the joint limits are exactly <em>one</em> pulse narrower than the servo limits. Also note that the <code>servo_pulse_upper_limit</code> of this servo is noticeably <em>lower</em> than those of most other servos (441, compare to ~500). <br  />
From these values, one can deduce that the real servo soft limits could not be determined, because the servo was already mounted in its joint with its sweep restricting hardware limits (see picture). <br  />
So, the <em>joint</em> lower and upper limits were determined, and the <em>servo</em> lower and upper limits were set 1 pulse wider that the joints'. It would be more logically to set the servo limits exactly the same as the joint limits, but in COSMOS Telemetry Definition however, for proper displaying the green, yellow and red limit bars the <code>Red Low Limit</code> and <code>Yellow Low Limit</code> cannot be exactly the same.</dd></dl>
<center> <img src="tisco-U1_Joint_ext_hardware-stop_1.jpg" alt="" height="240" class="inline"/> </center><p>0.</p>
<h1><a class="anchor" id="DOXY_CALIB_RESTART1"></a>
Recompile and Restart</h1>
<p>Recompile the firmware and upload to robot. The safe limits are now active.</p>
<h1><a class="anchor" id="DOXY_CALIB_TLM_AND_SCREEN"></a>
Calibration Telemetry Screen and Definition</h1>
<p>(See also: <a href="https://ballaerospace.github.io/cosmos-website/docs/v4/telemetry#limits">https://ballaerospace.github.io/cosmos-website/docs/v4/telemetry#limits</a>)</p>
<center> <img src="TELEMETRY_TLM_JOINTPWMPULSE_1.png" alt="" width="480" class="inline"/> <img src="tisco_CALIBRATE_1.png" alt="" width="400" class="inline"/> </center><p>Left image shows the telemetry definition of the JOINTPWMPULSE telemetry data with the limits definition. On the right, a COSMOS Telemetry Screen named 'Calibrate' with the same telemetry items and its limit bars. <br  />
Some servos show both <code>Red Low Limit</code> and <code>Yellow Low Limit</code> bars that result in green, yellow and red zones. <br  />
Other servos only show green and red zones, their <code>Red Low Limit</code> and <code>Yellow Low Limit</code> are exactly <em>one</em> apart (see Telemetry Definition).</p>
<p>Description:</p><ul>
<li>JOINTPWMPULSE_0: Servo is in operational range, servo limits and joint limits look the same... <br  />
 This looks like a servo that is either not yet mounted in a joint, or only the joint limits were determined and also used as servo limits (see earlier). Indeed, the first array in <code>g_joint_preset[NUMBER_OF_JOINTS]</code> reveals that servo and joint limits are just one pulse apart.</li>
<li>JOINTPWMPULSE_1: Servo is hitting the <em>joint</em> upper limit. Stepping further is not allowed. The servo upper limit is out of reach. <br  />
 This looks like a servo that is built into a joint, with external hardware switches. Indeed, see picture of servo 'U1' and in <code>g_joint_preset[NUMBER_OF_JOINTS]</code> with clearly distant servo and joint limits.</li>
<li>JOINTPWMPULSE_2: Looks similar als above. <br  />
 It turns out that the joint limits are not actual external hardware limits, but were chosen to have the servo move in a reasonable range. See picture of servo 'U3' and the third array in <code>g_joint_preset[NUMBER_OF_JOINTS]</code></li>
<li>JOINTPWMPULSE_3 and 4: They look similar as JOINTPWMPULSE_0. <br  />
 Servos 'S1' and 'S2' are not mounted in a joint, so their servo and joint limits are just one pulse apart as seen in <code>g_joint_preset[NUMBER_OF_JOINTS]</code></li>
<li>JOINTPWMPULSE_5: This is an unpowered servo (was driven with the special pulse value PCA9685_PWM_FULL).</li>
<li>JOINTPWMPULSE_6: This servo is in an illegal state: the servo shaft has been rotated (hy hand?) beyond the servo limits. See images: servo arm is between orange and red contoured arm positions. It cannot be powered on (let alone be stepped/moved), it must be moved manually in its unpowered state to the operational region before powering on.</li>
<li>JOINTPWMPULSE_7: When the mouse hovers over a label, detailed information like the exact limit values and the description is shown. Right-clicking a label reveals more options.</li>
</ul>
<h1><a class="anchor" id="DOXY_CALIB_JOINTANGLE_RAW_LIMITS"></a>
Joint/Servo Internal Angle Feedback Potentiometer Limits (JOINTANGLE_RAW)</h1>
<p>This section describes how to determine the <em>joint</em> lower and upper internal angle feedback potentiometer values. <br  />
They are read using <code>Joint::joint_angle_raw_fetch()</code> and use <code>analogRead()</code>, meaning that the read values depend on the <code>analogReference()</code> settings, specified with <code>ADC_REFERENCE_SETTING</code>. These values are ultimately mapped to corresponding servo pulses (see <code>to_pulse()</code>, used to record motions from an unpowered robot, by moving the joints by hand).</p>
<ol type="1">
<li>Verify that the servo and joint software limits are set and activated, as describe earlier. <dl class="section note"><dt>Note</dt><dd>The internal angle feedback potentiometer values are <em>not</em> dependant on the servo power supply voltage that can be set between 4.5V and 5.5V (small trim potentiometer on the Weidmuller power supply).</dd></dl>
</li>
<li>Follow all steps described in <a class="el" href="#DOXY_CALIB_JOINTPWMPULSE_LIMITS">Joint Lower and Upper Software Limits (JOINTPWMPULSE)</a>. <br  />
<ul>
<li>In addition to the <code>TLM_JOINTPWMPULSE</code> telemetry data, also send the command for periodically fetching <code>JOINTANGLE_RAW</code> telemetry.</li>
<li>For each servo, using <code>CMD_SET_JOINT_STEP</code> commands, sweep between the joints lower and upper software limits. <br  />
 Take note of the corresponding <code>JOINTANGLE_RAW</code> values. <b>Remember these values</b>.</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="DOXY_ENTERING_LIMITS_IN_FIRMWARE_AND_COSMOS2"></a>
Entering Limit Values in Firmware and COSMOS</h2>
<center> <img src="g_joint_preset[NUMBER_OF_JOINTS]_2.png" alt="" width="480" class="inline"/> <img src="TELEMETRY_TLM_JOINTANGLE_RAW_1.png" alt="" width="640" class="inline"/> </center><p>In <code>calibration_and_settings.h</code>, enter the determined JOINTANGLE_RAW values in <code>joint_angle_lower_limit</code> and <code>joint_angle_upper_limit</code> columns of <code>g_joint_preset[]</code>.</p>
<p>In file <code>tlm.txt</code>, find the telemetry definition of <code>JOINTPWMPULSE</code> and enter the found limit values next to the <code>LIMITS</code> statements, as shown in the image:</p><ul>
<li><code>Red Low Limit</code>: use <code>joint_angle_lower_limit</code> <em>minus 1</em> (see earlier why).</li>
<li><code>Yellow Low Limit</code>: use <code>joint_angle_lower_limit</code>.</li>
<li><code>Yellow High Limit</code>: use <code>joint_angle_upper_limit</code>.</li>
<li><code>Red High Limit</code>: use <code>joint_angle_upper_limit</code> <em>plus 1</em>.</li>
</ul>
<h1><a class="anchor" id="DOXY_CALIB_JOINTINPUT_LIMITS"></a>
Joint Analog Input Potentiometer Limits (JOINTINPUT_RAW)</h1>
<p>This section describes how to determine the joints analog input potentiometers. <br  />
They can take the form of a set of low cost modified potentiometers (see picture) mounted in a <em>Input Linkage Mechanism</em> that mimics the mechanical construction of the robot, one or more 3 axis joysticks (see picture)), or a combination of the two.</p>
<center> <img src="low_cost_modified_potmeter1.png" alt="" height="240" class="inline"/> <img src="J01_three_axis_joystick_SCALED.jpg" alt="" height="240" class="inline"/> </center><p>These analog inputs are read using <code>AnalogInput::fetch()</code> and use <code>analogRead()</code>, meaning that the read values <em>also</em> depend on the <code>analogReference()</code> settings, specified with <code>ADC_REFERENCE_SETTING</code>.</p>
<p>Currently, a simple voltage divider using a trim potentiometer steps the Arduino +5V to a voltage close to 2.5V (see picture).</p>
<center> <img src="JOINTINPUT_RAW_trim_potentiometer_1.jpg" alt="" height="240" class="inline"/> </center><pre class="fragment"> Input Linkage potentiometer ranges when using analogReference(DEFAULT).
  MIN/MAX : values when potentiometer is at 0°/180°

  How to calibrate the Input Linkage Mechanism's potentiometers
1) check the setting for ADC REFERENCE SETTING
2) turn all potentiometer to their physical limits clockwise
3) in COSMOS, check te output values.
4) adjust the input potentiometer trim potentiometer so that the values in COSMOS
   are maximize, an as close to the ADC limit as possible. In practice,
   say ~1000 (assuming ADC limit is 2^10 =&gt; 1023)
5) turn all ILM potentiometers to the maximum angle that they should be able to read.
6) record the COSMOS values and enter them in the appropriate place in de code
   Also, use these values for the COSMOS Limits settings
7) repeat for the minimum potentiometer angle values
8) done!
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Aug 13 2024 13:00:13 for TiSCo project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
